<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IoT Control Center</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ["Inter", "sans-serif"] },
          colors: {
            sky: { 50: "#f0f9ff", 100: "#e0f2fe", 200: "#bae6fd", 300: "#7dd3fc", 400: "#38bdf8", 500: "#0ea5e9", 600: "#0284c7", 700: "#0369a1" },
            emerald: { 50: "#f0fdf4", 400: "#34d399", 500: "#10b981", 600: "#059669" },
            amber: { 50: "#fffbeb", 400: "#fbbf24", 500: "#f59e0b" },
            rose: { 50: "#fff5f7", 400: "#fb7185", 500: "#f43f5e" },
          },
        },
      },
    };
  </script>

  <style>
    * { font-family: 'Inter', sans-serif; }
    body { background: linear-gradient(135deg, #f0f9ff 0%, #f5f3ff 100%); }
    
    .card-glow { box-shadow: 0 10px 30px rgba(14, 165, 233, 0.1); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .card-glow:hover { transform: translateY(-8px); box-shadow: 0 20px 40px rgba(14, 165, 233, 0.15); }
    
    .sensor-value { font-size: 2.5rem; font-weight: 800; background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    
    .badge-safe { background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); color: #047857; border: 1px solid #6ee7b7; }
    .badge-warn { background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); color: #b45309; border: 1px solid #fcd34d; }
    .badge-danger { background: linear-gradient(135deg, #fff5f7 0%, #fbecf0 100%); color: #be123c; border: 1px solid #fbcfe8; }
    
    .pulse-dot { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    .slider-thumb { accent-color: #0284c7; }
    
    .floating-btn { position: fixed; bottom: 2rem; right: 2rem; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; z-index: 50; transition: all 0.3s; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); }
    .floating-btn:hover { transform: scale(1.1); }

    .stat-box { background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%); border: 1px solid #e0f2fe; border-radius: 12px; padding: 1.5rem; }
    
    @keyframes buttonClick { 0% { transform: scale(1); } 50% { transform: scale(0.95); } 100% { transform: scale(1); } }
    @keyframes successPulse { 0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(76, 175, 80, 0); } 100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); } }
    @keyframes errorPulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    
    .relay-btn-active { animation: buttonClick 0.3s ease-in-out, successPulse 0.6s ease-out !important; }
    .relay-btn-inactive { animation: buttonClick 0.3s ease-in-out, errorPulse 0.6s ease-out !important; }

          <div class="space-y-4">
            <button onclick="controlRelay('ON')" class="w-full bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white font-bold py-4 px-6 rounded-xl transition transform hover:scale-105 active:scale-95 shadow-lg">
              ğŸ’¡ Turn ON
            </button>
            <button onclick="controlRelay('OFF')" class="w-full bg-gradient-to-r from-gray-400 to-gray-500 hover:from-gray-500 hover:to-gray-600 text-white font-bold py-4 px-6 rounded-xl transition transform hover:scale-105 active:scale-95 shadow-lg">
              ğŸ”Œ Turn OFF
            </button>
          </div>

          <div class="space-y-4">
            <button id="btn-relay-on" onclick="controlRelay('ON')" class="w-full bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white font-bold py-4 px-6 rounded-xl transition transform hover:scale-105 active:scale-95 shadow-lg duration-300">
              ğŸ’¡ Turn ON
            </button>
            <button id="btn-relay-off" onclick="controlRelay('OFF')" class="w-full bg-gradient-to-r from-gray-400 to-gray-500 hover:from-gray-500 hover:to-gray-600 text-white font-bold py-4 px-6 rounded-xl transition transform hover:scale-105 active:scale-95 shadow-lg duration-300">
              ğŸ”Œ Turn OFF
            </button>
          </div>

    window.controlRelay = function (status) {
      const relayRef = ref(db, "relay");
      set(relayRef, status)
        .then(() => addLog("Relay Control", `Relay switched to ${status}`))
        .catch((err) => console.error(err));
    };

    window.controlRelay = function (status) {
      const relayRef = ref(db, "relay");
      const button = status === "ON" ? document.getElementById("btn-relay-on") : document.getElementById("btn-relay-off");
      
      if (button) {
        button.classList.add(status === "ON" ? "relay-btn-active" : "relay-btn-inactive");
        setTimeout(() => {
          button.classList.remove(status === "ON" ? "relay-btn-active" : "relay-btn-inactive");
        }, 600);
      }
      
      set(relayRef, status)
        .then(() => addLog("Relay Control", `Relay switched to ${status}`))
        .catch((err) => console.error(err));
    };
    
    .chart-container { background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 10px 30px rgba(14, 165, 233, 0.08); }
  </style>
</head>

<body class="min-h-screen p-4 md:p-8">
  
  <!-- SIDEBAR TOGGLE BUTTON (Mobile) -->
  <button onclick="toggleSidebar()" class="md:hidden fixed top-4 left-4 z-50 bg-sky-500 text-white p-3 rounded-lg">
    â˜°
  </button>

  <!-- MAIN CONTAINER -->
  <div class="flex gap-6 max-w-7xl mx-auto">
    
    <!-- SIDEBAR -->
    <div id="sidebar" class="hidden md:block w-80 bg-white rounded-2xl p-6 h-fit sticky top-8 shadow-lg">
      <div class="mb-8">
        <h1 class="text-3xl font-bold bg-gradient-to-r from-sky-600 to-sky-700 bg-clip-text text-transparent mb-2">
          IoT Hub
        </h1>
        <p class="text-gray-500 text-sm">Real-time Monitoring & Control</p>
      </div>

      <!-- CONNECTION STATUS -->
      <div class="mb-8 p-4 rounded-xl bg-sky-50 border border-sky-200">
        <div class="flex items-center gap-3 mb-3">
          <span class="w-3 h-3 bg-emerald-500 rounded-full pulse-dot"></span>
          <span class="font-semibold text-gray-800" id="connectionStatus">Connected</span>
        </div>
        <p class="text-xs text-gray-600">Sistem siap dimonitor</p>
      </div>

      <!-- QUICK STATS -->
      <div class="space-y-3 mb-8">
        <div class="stat-box">
          <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Avg Temperature</p>
          <p class="text-2xl font-bold text-gray-900" id="statTemp">--Â°C</p>
        </div>
        <div class="stat-box">
          <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Avg Humidity</p>
          <p class="text-2xl font-bold text-gray-900" id="statHumidity">--%</p>
        </div>
        <div class="stat-box">
          <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">System Status</p>
          <p class="text-sm font-semibold text-emerald-600" id="systemHealth">âœ“ Healthy</p>
        </div>
      </div>

      <!-- NAVIGATION -->
      <div class="border-t pt-6">
        <p class="text-xs text-gray-500 uppercase tracking-wider font-semibold mb-4">Menu</p>
        <nav class="space-y-2">
          <div class="px-4 py-3 rounded-lg bg-sky-100 text-sky-700 font-medium cursor-pointer">ğŸ“Š Dashboard</div>
          <div class="px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-100 cursor-pointer transition">âš™ï¸ Settings</div>
          <div class="px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-100 cursor-pointer transition">ğŸ“‹ History</div>
        </nav>
      </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="flex-1 min-w-0">
      
      <!-- HEADER CARD -->
      <div class="bg-gradient-to-r from-sky-500 to-sky-600 rounded-2xl p-8 mb-8 text-white shadow-lg">
        <div class="flex justify-between items-start">
          <div>
            <h2 class="text-4xl font-bold mb-2">Sensor Dashboard</h2>
            <p class="text-sky-100">Monitor all IoT devices in real-time</p>
          </div>
          <div class="text-6xl">ğŸ›°ï¸</div>
        </div>
      </div>

      <!-- ALERT SECTION -->
      <div id="alertSection" class="hidden mb-8 p-6 rounded-2xl bg-gradient-to-r from-rose-50 to-rose-100 border-2 border-rose-300 shadow-md">
        <div class="flex gap-4">
          <div class="text-5xl">âš ï¸</div>
          <div class="flex-1">
            <h3 class="text-xl font-bold text-rose-900 mb-2">Alert System Active</h3>
            <ul id="alertList" class="space-y-1 text-rose-800 text-sm"></ul>
          </div>
        </div>
      </div>

      <!-- SENSOR GRID - 2x3 Layout -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
        
        <!-- TEMPERATURE CARD -->
        <div class="card-glow bg-white rounded-xl p-6">
          <div class="flex justify-between items-start mb-6">
            <div class="bg-gradient-to-br from-amber-50 to-orange-50 p-4 rounded-lg">
              <span class="text-4xl">ğŸŒ¡ï¸</span>
            </div>
            <div class="text-right">
              <p class="text-xs text-gray-500 uppercase tracking-wide">Temperature</p>
              <p class="sensor-value" id="val-temperature">--</p>
              <p class="text-xs text-gray-400">Â°C</p>
            </div>
          </div>
          <div id="status-temperature" class="badge-safe text-xs font-semibold py-2 px-3 rounded-lg inline-block">
            âœ“ Normal
          </div>
        </div>

        <!-- HUMIDITY CARD -->
        <div class="card-glow bg-white rounded-xl p-6">
          <div class="flex justify-between items-start mb-6">
            <div class="bg-gradient-to-br from-sky-50 to-blue-50 p-4 rounded-lg">
              <span class="text-4xl">ğŸ’§</span>
            </div>
            <div class="text-right">
              <p class="text-xs text-gray-500 uppercase tracking-wide">Humidity</p>
              <p class="sensor-value" id="val-humidity">--</p>
              <p class="text-xs text-gray-400">%</p>
            </div>
          </div>
          <div id="status-humidity" class="badge-safe text-xs font-semibold py-2 px-3 rounded-lg inline-block">
            âœ“ Normal
          </div>
        </div>

        <!-- FLAME DETECTION CARD -->
        <div class="card-glow bg-white rounded-xl p-6">
          <div class="flex justify-between items-start mb-6">
            <div class="bg-gradient-to-br from-rose-50 to-red-50 p-4 rounded-lg">
              <span class="text-4xl">ğŸ”¥</span>
            </div>
            <div class="text-right">
              <p class="text-xs text-gray-500 uppercase tracking-wide">Flame</p>
              <p class="sensor-value" id="val-flame">--</p>
              <p class="text-xs text-gray-400"></p>
            </div>
          </div>
          <div id="status-flame" class="badge-safe text-xs font-semibold py-2 px-3 rounded-lg inline-block">
            âœ“ Safe
          </div>
        </div>

        <!-- MQ2 GAS CARD -->
        <div class="card-glow bg-white rounded-xl p-6">
          <div class="flex justify-between items-start mb-6">
            <div class="bg-gradient-to-br from-purple-50 to-indigo-50 p-4 rounded-lg">
              <span class="text-4xl">â˜ï¸</span>
            </div>
            <div class="text-right">
              <p class="text-xs text-gray-500 uppercase tracking-wide">Gas MQ2</p>
              <p class="sensor-value" id="val-mq2">--</p>
              <p class="text-xs text-gray-400">PPM</p>
            </div>
          </div>
          <div id="status-mq2" class="badge-safe text-xs font-semibold py-2 px-3 rounded-lg inline-block">
            âœ“ Safe
          </div>
        </div>

        <!-- MQ7 CO CARD -->
        <div class="card-glow bg-white rounded-xl p-6">
          <div class="flex justify-between items-start mb-6">
            <div class="bg-gradient-to-br from-slate-50 to-gray-50 p-4 rounded-lg">
              <span class="text-4xl">â˜ ï¸</span>
            </div>
            <div class="text-right">
              <p class="text-xs text-gray-500 uppercase tracking-wide">CO MQ7</p>
              <p class="sensor-value" id="val-mq7">--</p>
              <p class="text-xs text-gray-400">PPM</p>
            </div>
          </div>
          <div id="status-mq7" class="badge-safe text-xs font-semibold py-2 px-3 rounded-lg inline-block">
            âœ“ Safe
          </div>
        </div>

        <!-- RELAY STATUS CARD -->
        <div class="card-glow bg-white rounded-xl p-6">
          <div class="flex justify-between items-start mb-6">
            <div class="bg-gradient-to-br from-emerald-50 to-teal-50 p-4 rounded-lg">
              <span class="text-4xl">âš¡</span>
            </div>
            <div class="text-right">
              <p class="text-xs text-gray-500 uppercase tracking-wide">Relay</p>
              <p class="sensor-value" id="val-relay">--</p>
              <p class="text-xs text-gray-400"></p>
            </div>
          </div>
          <div id="status-relay" class="badge-safe text-xs font-semibold py-2 px-3 rounded-lg inline-block">
            âœ“ Offline
          </div>
        </div>
      </div>

      <!-- CONTROL PANEL -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        
        <!-- RELAY CONTROL -->
        <div class="card-glow bg-white rounded-2xl p-8">
          <h3 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
            <span class="bg-emerald-100 p-3 rounded-lg text-2xl">âš¡</span>
            Relay Control
          </h3>
          <div class="space-y-4">
            <button onclick="controlRelay('ON')" class="w-full bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white font-bold py-4 px-6 rounded-xl transition transform hover:scale-105 active:scale-95 shadow-lg">
              ğŸ’¡ Turn ON
            </button>
            <button onclick="controlRelay('OFF')" class="w-full bg-gradient-to-r from-gray-400 to-gray-500 hover:from-gray-500 hover:to-gray-600 text-white font-bold py-4 px-6 rounded-xl transition transform hover:scale-105 active:scale-95 shadow-lg">
              ğŸ”Œ Turn OFF
            </button>
          </div>
          <div class="mt-6 p-4 bg-gray-50 rounded-lg text-center">
            <p class="text-xs text-gray-600 mb-2">Current State</p>
            <p class="text-2xl font-bold text-gray-900" id="relayState">--</p>
          </div>
        </div>

        <!-- EMERGENCY CALL -->
        <div class="card-glow bg-gradient-to-br from-red-50 to-rose-50 rounded-2xl p-8 border-2 border-red-300">
          <h3 class="text-2xl font-bold text-red-900 mb-6 flex items-center gap-3">
            <span class="bg-red-100 p-3 rounded-lg text-2xl animate-pulse">ğŸš¨</span>
            Emergency Call
          </h3>
          <p class="text-sm text-red-700 mb-6 font-medium">Quick call to fire department</p>
          <button onclick="emergencyCall()" class="w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-bold py-6 px-6 rounded-xl transition transform hover:scale-105 active:scale-95 shadow-lg text-lg">
            ğŸ“ CALL PEMADAM
          </button>
          <div class="mt-6 p-4 bg-white rounded-lg text-center">
            <p class="text-xs text-gray-600 mb-1">Emergency Number</p>
            <p class="text-xl font-bold text-red-600" id="emergencyNumber">113</p>
          </div>
        </div>
      </div>

      <!-- LIVE TRENDS CHART -->
      <div class="card-glow bg-white rounded-2xl p-8 mb-8">
        <h3 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
          <span class="bg-sky-100 p-3 rounded-lg text-2xl">ğŸ“ˆ</span>
          Live Trends (Last 15 min)
        </h3>
        <div class="h-64 w-full">
          <canvas id="sensorChart"></canvas>
        </div>
      </div>

      <!-- ACTIVITY LOG -->
      <div class="card-glow bg-white rounded-2xl p-8 mb-8">
        <h3 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
          <span class="bg-blue-100 p-3 rounded-lg text-2xl">ğŸ“‹</span>
          Activity Log
        </h3>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b-2 border-gray-200">
                <th class="text-left py-4 px-4 font-bold text-gray-700 uppercase text-xs tracking-wide">Time</th>
                <th class="text-left py-4 px-4 font-bold text-gray-700 uppercase text-xs tracking-wide">Event</th>
                <th class="text-left py-4 px-4 font-bold text-gray-700 uppercase text-xs tracking-wide">Status</th>
              </tr>
            </thead>
            <tbody id="activityLog" class="divide-y divide-gray-100">
              <tr>
                <td colspan="3" class="text-center py-8 text-gray-400">Waiting for data...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
  
      <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
      import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
    
      const firebaseConfig = {
        apiKey: "AIzaSyCARE47-MPU9e3I122u2gUkDlrA6c1DTRo",
        authDomain: "fireiot-14803.firebaseapp.com",
        databaseURL: "https://fireiot-14803-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "fireiot-14803",
        storageBucket: "fireiot-14803.firebasestorage.app",
        messagingSenderId: "144592823648",
        appId: "1:144592823648:web:4b8100210bd7b4d02caa05",
        measurementId: "G-NRHDQR4JJ8"
      };
    
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
    
      let sensorData = { flame: 0, humidity: 0, mq2: 0, mq7: 0, temperature: 0, relay: "OFF" };
      let chartInstance = null;
    
      // BACA DATA DARI sensorData (sesuai Firebase)
      const sensorsRef = ref(db, "sensorData");
      onValue(sensorsRef, (snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          updateAllDisplays(data);
          checkAlerts(data);
        } else {
          updateConnectionStatus(false);
        }
      }, (error) => {
        console.error(error);
        updateConnectionStatus(false);
      });
    
      // KONTROL RELAY + EFEK TOMBOL
      window.controlRelay = function (status) {
        const relayRef = ref(db, "sensorData/relay");
        const button = status === "ON"
          ? document.getElementById("btn-relay-on")
          : document.getElementById("btn-relay-off");
    
        if (button) {
          button.classList.add(status === "ON" ? "relay-btn-active" : "relay-btn-inactive");
          setTimeout(() => {
            button.classList.remove(status === "ON" ? "relay-btn-active" : "relay-btn-inactive");
          }, 600);
        }
    
        set(relayRef, status)
          .then(() => addLog("Relay Control", `Relay switched to ${status}`))
          .catch((err) => console.error(err));
      };
    
      window.toggleSidebar = function () {
        const sidebar = document.getElementById("sidebar");
        sidebar.classList.toggle("hidden");
      };
    
      window.emergencyCall = function () {
        const phoneNumber = "113";
        const confirmCall = confirm(`ğŸ“ Telepon ke Pemadam Kebakaran?\n\nNomor: ${phoneNumber}\n\nTekan OK untuk melanjutkan`);
        if (confirmCall) {
          window.location.href = `tel:${phoneNumber}`;
          addLog("Emergency Call", "Fire Department Called (113)");
        }
      };
    
      window.updateAllDisplays = function (data) {
        if (data.temperature !== undefined) {
          sensorData.temperature = data.temperature;
          updateSensorCard(
            "temperature",
            data.temperature.toFixed(1),
            "Â°C",
            data.temperature > 40 ? "danger" : data.temperature < 10 ? "warn" : "safe",
            data.temperature > 40 ? "ğŸ”¥ High" : data.temperature < 10 ? "â„ï¸ Low" : "âœ“ Normal"
          );
          document.getElementById("statTemp").textContent = data.temperature.toFixed(1) + "Â°C";
        }
    
        if (data.humidity !== undefined) {
          sensorData.humidity = data.humidity;
          updateSensorCard(
            "humidity",
            data.humidity.toFixed(1),
            "%",
            data.humidity < 30 || data.humidity > 70 ? "warn" : "safe",
            data.humidity < 30 ? "â¬‡ï¸ Low" : data.humidity > 70 ? "â¬†ï¸ High" : "âœ“ Normal"
          );
          document.getElementById("statHumidity").textContent = data.humidity.toFixed(1) + "%";
        }
    
        if (data.flame !== undefined) {
          sensorData.flame = data.flame;
          updateSensorCard(
            "flame",
            data.flame,
            "",
            data.flame > 0 ? "danger" : "safe",
            data.flame > 0 ? "ğŸ”¥ Detected" : "âœ“ Safe"
          );
        }
    
        if (data.mq2 !== undefined) {
          sensorData.mq2 = data.mq2;
          updateSensorCard(
            "mq2",
            data.mq2.toFixed(1),
            "PPM",
            data.mq2 > 1000 ? "danger" : data.mq2 > 500 ? "warn" : "safe",
            data.mq2 > 1000 ? "ğŸš¨ Danger" : data.mq2 > 500 ? "âš ï¸ Warning" : "âœ“ Safe"
          );
        }
    
        if (data.mq7 !== undefined) {
          sensorData.mq7 = data.mq7;
          updateSensorCard(
            "mq7",
            data.mq7.toFixed(1),
            "PPM",
            data.mq7 > 100 ? "danger" : data.mq7 > 50 ? "warn" : "safe",
            data.mq7 > 100 ? "ğŸš¨ Danger" : data.mq7 > 50 ? "âš ï¸ Warning" : "âœ“ Safe"
          );
        }
    
        if (data.relay !== undefined) {
          sensorData.relay = data.relay;
          const relayStatus = data.relay === "ON" ? "warn" : "safe";
          const relayText = data.relay === "ON" ? "âš¡ Active" : "âœ“ Offline";
          updateSensorCard("relay", data.relay, "", relayStatus, relayText);
          document.getElementById("relayState").textContent = data.relay;
        }
    
        updateChart();
        addLog("Sensor Update", "All sensors updated");
        updateConnectionStatus(true);
      };
    
      function updateSensorCard(sensor, value, unit, status, statusText) {
        const valEl = document.getElementById(`val-${sensor}`);
        const statusEl = document.getElementById(`status-${sensor}`);
        if (valEl) valEl.textContent = value;
        if (statusEl) {
          statusEl.textContent = statusText;
          statusEl.className = `badge-${status} text-xs font-semibold py-2 px-3 rounded-lg inline-block`;
        }
      }
    
      window.checkAlerts = function (data) {
        const alerts = [];
        if (data.flame > 0) alerts.push("ğŸ”¥ Flame detected!");
        if (data.mq2 > 1000) alerts.push(`âš ï¸ High gas level: ${data.mq2.toFixed(0)} PPM`);
        if (data.mq7 > 100) alerts.push(`â˜ ï¸ CO level critical: ${data.mq7.toFixed(0)} PPM`);
        if (data.temperature > 40) alerts.push(`ğŸ”¥ Temperature critical: ${data.temperature.toFixed(0)}Â°C`);
    
        const alertSection = document.getElementById("alertSection");
        const alertList = document.getElementById("alertList");
    
        if (alerts.length > 0) {
          alertSection.classList.remove("hidden");
          alertList.innerHTML = alerts.map(a => `<li>â€¢ ${a}</li>`).join("");
        } else {
          alertSection.classList.add("hidden");
        }
      };
    
      function updateConnectionStatus(connected) {
        const statusEl = document.getElementById("connectionStatus");
        if (statusEl) {
          statusEl.textContent = connected ? "Connected" : "Disconnected";
          statusEl.parentElement.querySelector("span").className =
            connected ? "w-3 h-3 bg-emerald-500 rounded-full pulse-dot" : "w-3 h-3 bg-rose-500 rounded-full";
        }
      }
    
      function initChart() {
        const ctx = document.getElementById("sensorChart").getContext("2d");
        chartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              { label: "Temp (Â°C)", data: [], borderColor: "#f59e0b", backgroundColor: "rgba(245, 158, 11, 0.1)", borderWidth: 3, fill: true, tension: 0.4, pointRadius: 4, pointBackgroundColor: "#f59e0b" },
              { label: "Humidity (%)", data: [], borderColor: "#0ea5e9", backgroundColor: "rgba(14, 165, 233, 0.1)", borderWidth: 3, fill: true, tension: 0.4, pointRadius: 4, pointBackgroundColor: "#0ea5e9" },
              { label: "MQ2 (PPM)", data: [], borderColor: "#ef4444", backgroundColor: "rgba(239, 68, 68, 0.1)", borderWidth: 3, fill: false, tension: 0.4, pointRadius: 4, pointBackgroundColor: "#ef4444" },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { labels: { color: "#6b7280", font: { size: 13, weight: 600 }, padding: 15 } },
              filler: { propagate: true }
            },
            scales: {
              y: { ticks: { color: "#9ca3af", font: { size: 12 } }, grid: { color: "rgba(0, 0, 0, 0.05)" }, beginAtZero: true },
              x: { ticks: { color: "#9ca3af", font: { size: 12 } }, grid: { color: "rgba(0, 0, 0, 0.05)" } },
            },
          },
        });
      }
    
      window.updateChart = function () {
        if (!chartInstance) return;
        const now = new Date().toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" });
    
        if (chartInstance.data.labels.length >= 15) {
          chartInstance.data.labels.shift();
          chartInstance.data.datasets.forEach(d => d.data.shift());
        }
    
        chartInstance.data.labels.push(now);
        chartInstance.data.datasets[0].data.push(sensorData.temperature);
        chartInstance.data.datasets[1].data.push(sensorData.humidity);
        chartInstance.data.datasets[2].data.push(sensorData.mq2);
        chartInstance.update("none");
      };
    
      window.addLog = function (event, status) {
        const time = new Date().toLocaleTimeString("id-ID");
        const tbody = document.getElementById("activityLog");
    
        if (tbody.children.length === 1 && tbody.children[0].children[0].colSpan === 3) {
          tbody.innerHTML = "";
        }
    
        const row = document.createElement("tr");
        row.className = "hover:bg-gray-50 transition";
        row.innerHTML = `
          <td class="py-4 px-4 text-gray-600">${time}</td>
          <td class="py-4 px-4 font-medium text-gray-900">${event}</td>
          <td class="py-4 px-4"><span class="inline-block bg-sky-100 text-sky-700 px-3 py-1 rounded-full text-xs font-semibold">${status}</span></td>
        `;
    
        tbody.insertBefore(row, tbody.firstChild);
        while (tbody.children.length > 12) tbody.removeChild(tbody.lastChild);
      };
    
      window.addEventListener("load", () => {
        initChart();
        updateConnectionStatus(false);
      });
    </script>
</body>
</html>
